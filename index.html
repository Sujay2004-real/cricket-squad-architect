<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Squad Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .timer-bar {
            transition: width 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .player-card {
            transition: all 0.3s ease;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .team-section.active-section {
            background-color: #1f2937; /* bg-gray-800 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
            z-index: 40;
        }
        .modal-content {
            z-index: 50;
        }
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tutorial-box {
            background: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            color: white;
            max-width: 500px;
            text-align: center;
            position: relative;
            border: 1px solid #374151;
        }
        .highlight-element {
            position: absolute;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 20px #3b82f6;
            z-index: 1000;
            pointer-events: none;
            transition: all 0.3s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app">
        <!-- Home Screen -->
        <div id="homeScreen" class="min-h-screen flex flex-col items-center justify-center p-4">
            <h1 class="text-5xl font-bold text-blue-400 mb-2">Cricket Squad Architect</h1>
            <p class="text-gray-400 mb-8">The Ultimate Draft & Auction Challenge</p>
            <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
                <label for="teamNameInput" class="block text-sm font-medium text-gray-300 mb-2">Enter Your Team Name</label>
                <div class="flex gap-2">
                    <input type="text" id="teamNameInput" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Strategic Strikers">
                    <button id="suggestNameBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-md transition duration-300 flex-shrink-0" title="✨ Suggest a Name with AI">✨</button>
                </div>
                <button id="startGameBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md mt-6 transition duration-300">Start New Game</button>
                <button id="viewLastGameBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md mt-3 transition duration-300">View Last Game</button>
                 <button id="tutorialBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md mt-3 transition duration-300">How to Play (Tutorial)</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <header class="bg-gray-800 p-3 flex justify-between items-center sticky top-0 z-30 shadow-lg">
                <h2 class="text-2xl font-bold">Round <span id="roundCounter">1</span></h2>
                <div class="text-center">
                    <p class="text-lg font-semibold" id="gameStatus">Section A's Turn</p>
                    <p class="text-sm text-gray-400" id="currentPicker">Initializing...</p>
                </div>
                <div class="text-right">
                    <h3 class="text-lg font-semibold" id="userTeamName">Your Team</h3>
                    <p class="text-green-400 font-mono" id="userPurse">Purse: $100M</p>
                </div>
            </header>

            <main class="flex flex-col lg:flex-row p-4 gap-4">
                <!-- Teams Display -->
                <div class="w-full lg:w-1/4">
                    <div id="teamsContainerA" class="team-section mb-4 p-4 bg-gray-800/50 rounded-lg">
                        <h3 class="text-xl font-bold mb-2 border-b border-gray-700 pb-2">Section A</h3>
                        <div id="teamListA" class="space-y-3"></div>
                    </div>
                    <div id="teamsContainerB" class="team-section p-4 bg-gray-800/50 rounded-lg">
                        <h3 class="text-xl font-bold mb-2 border-b border-gray-700 pb-2">Section B</h3>
                        <div id="teamListB" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Main Game Area -->
                <div class="w-full lg:w-1/2 flex flex-col gap-4">
                    <!-- Player Input Area -->
                    <div id="playerInputArea" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                         <h3 class="text-xl font-bold mb-4 text-center">Your Turn: Make Your Selection</h3>
                        <div id="timerContainer" class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
                            <div id="timerBar" class="bg-blue-500 h-2.5 rounded-full timer-bar" style="width: 100%"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="slabSelect" class="block text-sm font-medium text-gray-300 mb-2">Choose a Slab</label>
                                <select id="slabSelect" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="gold">Gold</option>
                                    <option value="silver">Silver</option>
                                    <option value="bronze">Bronze</option>
                                </select>
                            </div>
                            <div>
                                <label for="numberInput" class="block text-sm font-medium text-gray-300 mb-2">Choose a Number (<span id="numberRange"></span>)</label>
                                <input type="number" id="numberInput" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" min="1">
                            </div>
                        </div>
                        <button id="submitPickBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-md mt-4 transition duration-300">Submit Pick</button>
                    </div>

                    <!-- Auction/Player Display -->
                    <div id="auctionArea" class="bg-gray-800 p-6 rounded-lg shadow-lg flex-grow flex items-center justify-center text-center">
                        <p id="auctionStatus" class="text-gray-400 text-lg">Waiting for selections...</p>
                    </div>
                </div>

                <!-- Game Log -->
                <div class="w-full lg:w-1/4 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold mb-2 border-b border-gray-700 pb-2">Game Log</h3>
                    <div id="gameLog" class="h-96 overflow-y-auto space-y-2 text-sm pr-2"></div>
                </div>
            </main>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
            <h1 class="text-5xl font-bold text-blue-400 mb-4">Draft Complete!</h1>
            <p class="text-gray-300 mb-8">Review the final squads below. Use the ✨ AI Analyst for insights!</p>
            <div id="finalSquads" class="w-full max-w-6xl mx-auto"></div>
            <button id="playAgainBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md mt-8 transition duration-300">Play Again</button>
        </div>

        <!-- Last Game View Screen -->
        <div id="lastGameScreen" class="hidden min-h-screen flex flex-col items-center p-4">
             <h1 class="text-4xl font-bold text-blue-400 my-6">Last Game Results</h1>
             <div id="lastGameSquads" class="w-full max-w-6xl mx-auto"></div>
             <button id="backToHomeBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-md mt-8 transition duration-300">Back to Home</button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-lg modal-content fade-in">
            <div id="modal-content-container">
                 <h3 id="modalTitle" class="text-2xl font-bold mb-4">Modal Title</h3>
                <p id="modalText" class="text-gray-300 mb-6">Modal body text goes here.</p>
                <div id="modalTimer" class="w-full bg-gray-700 rounded-full h-2.5 mb-4 hidden">
                    <div id="modalTimerBar" class="bg-blue-500 h-2.5 rounded-full timer-bar" style="width: 100%"></div>
                </div>
                <div id="modalButtons" class="flex justify-end gap-4">
                    <!-- Buttons are added dynamically -->
                </div>
                <div id="modalBidInputContainer" class="hidden mt-4">
                    <label for="bidAmount" class="block text-sm font-medium text-gray-300 mb-2">Enter Bid Amount (in Millions)</label>
                    <input type="number" id="bidAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="e.g., 5.5">
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="hidden tutorial-overlay">
        <div class="tutorial-box">
            <h2 id="tutorialTitle" class="text-3xl font-bold text-blue-400 mb-4">Welcome to the Tutorial!</h2>
            <p id="tutorialText" class="mb-6">This will guide you through the basics of Cricket Squad Architect.</p>
            <button id="tutorialNextBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md">Start</button>
        </div>
    </div>
    <div id="highlightBox" class="highlight-element hidden"></div>

    <script type="module">
        // --- GAME CONFIGURATION ---
        const CONFIG = {
            NUM_TEAMS: 10,
            SLOTS_PER_TEAM: 27, // For testing, a smaller number might be faster, e.g., 5
            INITIAL_PURSE: 100, // In Millions
            DECISION_TIMER_SECONDS: 15,
        };

        // --- MOCK PLAYER DATA ---
        const PLAYER_DATA = {
            gold: [],
            silver: [],
            bronze: [],
        };
        
        // --- UTILITY FUNCTIONS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        function generatePlayers() {
            const perks = ["Death Overs Specialist", "Power Hitter", "Spin Maestro", "Pace Spearhead", "Master Finisher", "Economical Bowler", "Aggressive Opener"];
            const accomplishments = ["5-Wicket Haul", "Century in T20", "Hat-trick", "Fastest 50", "Most Valuable Player Award"];
            let idCounter = 1;

            for (let i = 1; i <= 25; i++) {
                PLAYER_DATA.gold.push({ id: idCounter++, name: `Gold Player ${i}`, slab: 'gold', perk: perks[i % perks.length], accomplishments: accomplishments[i % accomplishments.length], premium: i <= 3 });
            }
            for (let i = 1; i <= 40; i++) {
                PLAYER_DATA.silver.push({ id: idCounter++, name: `Silver Player ${i}`, slab: 'silver', perk: perks[i % perks.length], accomplishments: accomplishments[i % accomplishments.length], premium: false });
            }
            for (let i = 1; i <= 60; i++) {
                PLAYER_DATA.bronze.push({ id: idCounter++, name: `Bronze Player ${i}`, slab: 'bronze', perk: perks[i % perks.length], accomplishments: accomplishments[i % accomplishments.length], premium: false });
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- APPLICATION STATE ---
        let gameState = {};
        let teams = [];
        let timerInterval;

        // --- CORE GAME LOGIC ---
        function initGame() {
            // ... (existing initGame code, unchanged) ...
            gameState = {
                round: 1,
                turn: 0,
                currentSection: 'A',
                isRoundInProgress: false,
                isGameOver: false,
                gameLog: [],
                availablePlayers: JSON.parse(JSON.stringify(PLAYER_DATA)),
                tutorialActive: false,
                tutorialStep: 0,
            };
            
            teams = [];
            for (let i = 0; i < CONFIG.NUM_TEAMS; i++) {
                const isCPU = i > 0;
                teams.push({
                    id: i,
                    name: isCPU ? `CPU Team ${i}` : ($('#teamNameInput').value || 'My Team'),
                    isCPU: isCPU,
                    section: i < CONFIG.NUM_TEAMS / 2 ? 'A' : 'B',
                    purse: CONFIG.INITIAL_PURSE,
                    squad: [],
                    consecutiveRejections: 0,
                    pick: null,
                });
            }
            
            $('#userTeamName').textContent = teams[0].name;
            updatePurseDisplay(0);
            renderAllTeams();
            
            $('#homeScreen').classList.add('hidden');
            $('#lastGameScreen').classList.add('hidden');
            $('#gameOverScreen').classList.add('hidden');
            $('#gameScreen').classList.remove('hidden');
            $('#gameLog').innerHTML = '';

            startRound();
        }

        async function startRound() {
            if (gameState.isGameOver) return;
            
            logMessage(`--- Round ${gameState.round} Begins ---`);
            const teamsInPlay = teams.filter(t => t.section === gameState.currentSection && t.squad.length < CONFIG.SLOTS_PER_TEAM);

            if (teamsInPlay.length === 0) {
                logMessage(`No teams in Section ${gameState.currentSection} need players. Skipping.`);
                await sleep(1000);
                endRound();
                return;
            }

            gameState.isRoundInProgress = true;
            $('#roundCounter').textContent = gameState.round;
            $('#gameStatus').textContent = `Section ${gameState.currentSection}'s Turn`;
            
            $(`#teamsContainer${gameState.currentSection}`).classList.add('active-section');
            const otherSection = gameState.currentSection === 'A' ? 'B' : 'A';
            $(`#teamsContainer${otherSection}`).classList.remove('active-section');
            
            $('#auctionArea').innerHTML = `<p id="auctionStatus" class="text-gray-400 text-lg">Waiting for Section ${gameState.currentSection} to make their picks...</p>`;

            // Reset picks for all teams in the current section
            teams.forEach(team => {
                if (team.section === gameState.currentSection) {
                    team.pick = null;
                }
            });
            
            if (gameState.tutorialActive) {
                runTutorialStep();
                return; // Tutorial will drive the flow
            }

            // Get picks from all teams in the section
            const pickPromises = teamsInPlay.map(team => getTeamPick(team));
            await Promise.all(pickPromises);
            
            logMessage(`All picks from Section ${gameState.currentSection} are in. Processing...`);
            await processRoundPicks();
        }

        function getTeamPick(team) {
            return new Promise((resolve) => {
                if (team.isCPU) {
                    setTimeout(() => {
                        try {
                            team.pick = generateCpuPick(team);
                            logMessage(`${team.name} has made its selection.`);
                            resolve();
                        } catch (error) {
                            console.error(`Error generating pick for ${team.name}:`, error);
                            team.pick = null; 
                            logMessage(`An error occurred for ${team.name}. They will not participate in this round.`, 'red');
                            resolve(); // IMPORTANT: Resolve even on error to prevent the game from hanging.
                        }
                    }, Math.random() * 2000 + 1000);
                } else {
                    enablePlayerInput(resolve);
                }
            });
        }

        function enablePlayerInput(resolve) {
            // ... (existing enablePlayerInput code, unchanged) ...
            $('#playerInputArea').classList.remove('hidden');
            $('#submitPickBtn').onclick = () => {
                const slab = $('#slabSelect').value;
                const number = parseInt($('#numberInput').value);
                const max = PLAYER_DATA[slab].length;

                if (isNaN(number) || number < 1 || number > max) {
                    // Using a custom modal instead of alert
                    showInfoModal("Invalid Input", `Please enter a valid number between 1 and ${max}.`);
                    return;
                }

                teams[0].pick = { slab, number };
                logMessage(`You selected the ${slab} slab, number ${number}.`);
                $('#playerInputArea').classList.add('hidden');
                clearInterval(timerInterval);
                resolve();
            };
            
            $('#slabSelect').onchange = updateNumberRange;
            updateNumberRange();
            startTimer($('#timerBar'), CONFIG.DECISION_TIMER_SECONDS, () => {
                logMessage(`Time's up! A random pick was made for you.`);
                teams[0].pick = generateRandomPick();
                $('#playerInputArea').classList.add('hidden');
                resolve();
            });
        }
        
        function generateRandomPick() {
            // ... (existing generateRandomPick code, unchanged) ...
            const slabs = ['gold', 'silver', 'bronze'];
            const slab = slabs[Math.floor(Math.random() * slabs.length)];
            const max = PLAYER_DATA[slab].length;
            const number = Math.floor(Math.random() * max) + 1;
            return { slab, number };
        }

        function generateCpuPick(team) {
            // ... (existing generateCpuPick code, unchanged) ...
            let slab;
            const rand = Math.random();
            if (team.purse > CONFIG.INITIAL_PURSE * 0.7 && rand < 0.5) {
                slab = 'gold'; // Aggressive Bidder
            } else if (team.purse < CONFIG.INITIAL_PURSE * 0.3 && rand < 0.6) {
                slab = 'bronze'; // Budget-Conscious
            } else {
                slab = 'silver';
            }
            
            if (gameState.availablePlayers[slab].length === 0) {
                if (gameState.availablePlayers['silver'].length > 0) slab = 'silver';
                else if (gameState.availablePlayers['bronze'].length > 0) slab = 'bronze';
                else slab = 'gold';
            }

            const max = PLAYER_DATA[slab].length;
            const number = Math.floor(Math.random() * max) + 1;
            return { slab, number };
        }

        async function processRoundPicks() {
            // ... (existing processRoundPicks code, unchanged) ...
             const picks = teams
                .filter(t => t.section === gameState.currentSection && t.pick)
                .map(t => ({ teamId: t.id, ...t.pick }));

            if (picks.length === 0) {
                logMessage("No valid picks to process.");
                endRound();
                return;
            }

            const goldPicks = picks.filter(p => p.slab === 'gold');
            const silverPicks = picks.filter(p => p.slab === 'silver');
            const bronzePicks = picks.filter(p => p.slab === 'bronze');
            
            if (goldPicks.length > 0 && gameState.availablePlayers.gold.length > 0) {
                await handleAuction(goldPicks, 'gold');
            } else if (silverPicks.length > 0 && gameState.availablePlayers.silver.length > 0) {
                await handleAuction(silverPicks, 'silver');
            } else if (bronzePicks.length > 0 && gameState.availablePlayers.bronze.length > 0) {
                 await handleAuction(bronzePicks, 'bronze');
            } else {
                logMessage("No available players in the chosen slabs for this round.");
            }
            
            endRound();
        }

        async function handleAuction(picks, slab) {
            // ... (existing handleAuction code, unchanged) ...
            logMessage(`Auctioning from the ${slab.toUpperCase()} slab.`);
            const availableSlabPlayers = gameState.availablePlayers[slab];
            if(availableSlabPlayers.length === 0) {
                logMessage(`No more players in the ${slab} slab.`);
                return;
            }
            
            const randgenIndex = Math.floor(Math.random() * availableSlabPlayers.length);
            const targetPlayer = availableSlabPlayers[randgenIndex];
            const randgenNumber = PLAYER_DATA[slab].findIndex(p => p.id === targetPlayer.id) + 1;

            logMessage(`System generated number is ${randgenNumber}. Player on auction: ${targetPlayer.name}.`);
            $('#auctionArea').innerHTML = renderPlayerCard(targetPlayer, 'Player on Auction');

            const exactMatchTeam = picks.find(p => p.number === randgenNumber);
            if (exactMatchTeam) {
                const winner = teams.find(t => t.id === exactMatchTeam.teamId);
                logMessage(`EXACT MATCH! ${winner.name} gets ${targetPlayer.name} for free!`, 'gold');
                await awardPlayer(winner, targetPlayer, 0);
                return;
            }
            
            const priorityList = picks
                .map(p => ({ ...p, diff: Math.abs(p.number - randgenNumber) }))
                .sort((a, b) => a.diff - b.diff)
                .slice(0, 3)
                .map(p => teams.find(t => t.id === p.teamId));

            logMessage(`Priority List: ${priorityList.map(t => t.name).join(', ')}`);
            
            await runBiddingProcess(priorityList, targetPlayer);
        }
        
        async function runBiddingProcess(priorityList, player) {
            // ... (existing runBiddingProcess code, unchanged) ...
            if (priorityList.length === 0) {
                logMessage("No teams on priority list. Player not sold.");
                return;
            }
            
            let currentHolder = null;
            let currentPrice = 0;
            
            const team1 = priorityList[0];
            const team1Accepts = await getTeamDecision(team1, player, `You have top priority. Acquire ${player.name} for free?`, ['Accept', 'Reject']);
            
            if (team1Accepts) {
                logMessage(`${team1.name} accepts ${player.name} for free.`);
                currentHolder = team1;
                
                if (priorityList.length > 1) {
                    const team2 = priorityList[1];
                    const team2Challenges = await getTeamDecision(team2, player, `${team1.name} took ${player.name}. Do you want to challenge with a bid?`, ['Challenge', 'Pass']);
                    
                    if (team2Challenges) {
                        const bid = await getBidAmount(team2, player);
                        logMessage(`${team2.name} challenges with a bid of $${bid}M.`);
                        
                        const team1AcceptsBid = await getTeamDecision(team1, player, `${team2.name} bid $${bid}M. Match bid to keep ${player.name}?`, ['Match Bid', 'Reject Bid']);
                        
                        if (team1AcceptsBid) {
                            logMessage(`${team1.name} matches the bid.`);
                            currentPrice = bid;
                        } else {
                            logMessage(`${team1.name} rejects the bid. ${team2.name} gets the player.`);
                            currentHolder = team2;
                            currentPrice = bid;
                        }
                    }
                }
            } else {
                logMessage(`${team1.name} rejects ${player.name}.`);
                team1.consecutiveRejections++;
                
                if (priorityList.length > 1) {
                    const team2 = priorityList[1];
                    const team2Accepts = await getTeamDecision(team2, player, `${team1.name} rejected. Acquire ${player.name} for free?`, ['Accept', 'Reject']);
                    
                    if (team2Accepts) {
                        logMessage(`${team2.name} accepts ${player.name} for free.`);
                        currentHolder = team2;
                        
                        if (priorityList.length > 2) {
                            const team3 = priorityList[2];
                            const team3Challenges = await getTeamDecision(team3, player, `${team2.name} took ${player.name}. Do you want to challenge?`, ['Challenge', 'Pass']);
                            
                            if (team3Challenges) {
                                const bid = await getBidAmount(team3, player);
                                logMessage(`${team3.name} challenges with a bid of $${bid}M.`);
                                
                                const team2AcceptsBid = await getTeamDecision(team2, player, `${team3.name} bid $${bid}M. Match bid?`, ['Match Bid', 'Reject Bid']);
                                if (team2AcceptsBid) {
                                    logMessage(`${team2.name} matches the bid.`);
                                    currentPrice = bid;
                                } else {
                                    logMessage(`${team2.name} rejects bid. ${team3.name} gets the player.`);
                                    currentHolder = team3;
                                    currentPrice = bid;
                                }
                            }
                        }
                    } else {
                        logMessage(`${team2.name} rejects ${player.name}.`);
                        team2.consecutiveRejections++;
                        
                        if(priorityList.length > 2) {
                            const team3 = priorityList[2];
                            const team3Accepts = await getTeamDecision(team3, player, `Player available. Acquire for free?`, ['Accept', 'Reject']);
                             if (team3Accepts) {
                                logMessage(`${team3.name} accepts ${player.name} for free.`);
                                currentHolder = team3;
                            } else {
                                logMessage(`${team3.name} also rejects. Player goes unsold.`);
                                team3.consecutiveRejections++;
                            }
                        }
                    }
                }
            }
            
            if (currentHolder) {
                await awardPlayer(currentHolder, player, currentPrice);
            }
        }
        
        function getTeamDecision(team, player, prompt, options) {
            // ... (existing getTeamDecision code, unchanged) ...
            if (options.includes('Reject') && team.consecutiveRejections >= 2) {
                logMessage(`FORCED PICK! ${team.name} cannot reject ${player.name}.`);
                return Promise.resolve(true); // Must accept
            }
            
            if (team.isCPU) {
                return new Promise(resolve => setTimeout(() => resolve(cpuMakeDecision(team, player, options)), 1500));
            } else {
                return showModalPrompt(prompt, options);
            }
        }
        
        function cpuMakeDecision(team, player, options) {
            // ... (existing cpuMakeDecision code, unchanged) ...
            const willAccept = Math.random() > 0.3;
            if(options[0] === 'Challenge') return Math.random() > 0.5;
            if(options[0] === 'Match Bid') return team.purse > 15 && Math.random() > 0.4;
            return willAccept;
        }

        async function getBidAmount(team, player) {
            // ... (existing getBidAmount code, unchanged) ...
            if (team.isCPU) {
                const bidPercentage = team.purse > 50 ? 0.15 : 0.08;
                return Promise.resolve(Math.round((team.purse * bidPercentage) * 10) / 10);
            } else {
                const bid = await showModalPrompt(`How much do you want to bid for ${player.name}? (Max: $${team.purse}M)`, ['Submit Bid'], true);
                const amount = parseFloat($('#bidAmount').value);
                if (isNaN(amount) || amount <= 0 || amount > team.purse) {
                    logMessage("Invalid bid. A default bid of $1M is placed.");
                    return 1;
                }
                return amount;
            }
        }

        async function awardPlayer(team, player, price) {
            // ... (existing awardPlayer code, unchanged) ...
            if (team.purse < price) {
                logMessage(`${team.name} cannot afford $${price}M for ${player.name}. Sale cancelled.`);
                return;
            }
            
            team.purse -= price;
            team.squad.push(player);
            team.consecutiveRejections = 0;

            const slab = player.slab;
            gameState.availablePlayers[slab] = gameState.availablePlayers[slab].filter(p => p.id !== player.id);
            
            logMessage(`${team.name} signs ${player.name} for $${price}M!`, 'green');
            renderTeam(team.id);
            updatePurseDisplay(team.id);
            await sleep(1500);
        }

        function endRound() {
            // ... (existing endRound code, unchanged) ...
            gameState.isRoundInProgress = false;
            
            const isEveryTeamFull = teams.every(t => t.squad.length >= CONFIG.SLOTS_PER_TEAM);
            if (isEveryTeamFull) {
                endGame();
                return;
            }
            
            gameState.currentSection = gameState.currentSection === 'A' ? 'B' : 'A';
            if (gameState.currentSection === 'A') {
                gameState.round++;
            }
            
            setTimeout(startRound, 2000);
        }

        function endGame() {
            // ... (existing endGame code, unchanged) ...
            gameState.isGameOver = true;
            logMessage(`--- GAME OVER ---`);
            $('#gameScreen').classList.add('hidden');
            $('#gameOverScreen').classList.remove('hidden');
            
            const gameData = teams.map(t => ({name: t.name, squad: t.squad}));
            localStorage.setItem('lastCricketGame', JSON.stringify(gameData));
            
            renderFinalSquads('finalSquads');
        }

        // --- UI & RENDERING ---
        function renderAllTeams() {
            // ... (existing renderAllTeams code, unchanged) ...
            teams.forEach(team => renderTeam(team.id));
        }
        
        function renderTeam(teamId) {
            // ... (existing renderTeam code, unchanged) ...
            const team = teams[teamId];
            const teamDiv = $(`#team-${teamId}`);
            if (teamDiv) teamDiv.remove();

            const listId = team.section === 'A' ? '#teamListA' : '#teamListB';
            const shortSquadList = team.squad.slice(0, 3).map(p => `<span class="text-xs px-1.5 py-0.5 rounded ${p.slab === 'gold' ? 'bg-yellow-600' : p.slab === 'silver' ? 'bg-gray-500' : 'bg-yellow-800'}">${p.name.split(' ')[0][0]}${p.name.split(' ')[1][0]}</span>`).join(' ');
            const remaining = team.squad.length > 3 ? ` +${team.squad.length - 3}` : '';

            const element = `
                <div id="team-${teamId}" class="p-2 rounded-md ${team.isCPU ? 'bg-gray-700/50' : 'bg-blue-900/70 border border-blue-500'}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-sm">${team.name}</span>
                        <span class="text-xs font-mono text-green-400">$${team.purse.toFixed(1)}M</span>
                    </div>
                    <div class="flex justify-between items-center mt-1 text-gray-300">
                         <div class="text-xs truncate" title="${team.squad.map(p=>p.name).join(', ')}">${shortSquadList}${remaining}</div>
                         <span class="text-xs font-medium">${team.squad.length}/${CONFIG.SLOTS_PER_TEAM}</span>
                    </div>
                </div>
            `;
            $(listId).insertAdjacentHTML('beforeend', element);
        }
        
        function renderPlayerCard(player, title) {
            // ... (existing renderPlayerCard code, unchanged) ...
            const premiumBadge = player.premium ? '<span class="absolute top-2 right-2 text-xs bg-purple-600 px-2 py-1 rounded-full font-bold shadow-lg">PREMIUM</span>' : '';
            return `
                <div class="player-card relative bg-gray-700 p-6 rounded-lg shadow-xl border-2 ${player.slab === 'gold' ? 'border-yellow-500' : player.slab === 'silver' ? 'border-gray-400' : 'border-yellow-700'} w-full max-w-sm fade-in">
                    <p class="text-sm text-gray-400 mb-2">${title}</p>
                    <h3 class="text-3xl font-bold">${player.name}</h3>
                    <p class="capitalize font-semibold mt-1 ${player.slab === 'gold' ? 'text-yellow-400' : player.slab === 'silver' ? 'text-gray-300' : 'text-yellow-600'}">${player.slab} Slab</p>
                    ${premiumBadge}
                    <div class="mt-4 text-left space-y-2">
                        <p><strong class="text-gray-300">Perk:</strong> <span class="text-blue-300">${player.perk}</span></p>
                        <p><strong class="text-gray-300">Accomplishments:</strong> <span class="text-gray-300">${player.accomplishments}</span></p>
                    </div>
                </div>
            `;
        }
        
        function renderFinalSquads(containerId) {
            const container = $(`#${containerId}`);
            container.innerHTML = '';
            const finalTeamsData = JSON.parse(localStorage.getItem('lastCricketGame') || '[]');
            
            if (finalTeamsData.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-400">No game data found.</p>`;
                 return;
            }

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">';
            finalTeamsData.forEach((team, index) => {
                html += `
                    <div class="bg-gray-800 p-4 rounded-lg flex flex-col">
                        <h3 class="text-xl font-bold mb-3 text-blue-300">${team.name}</h3>
                        <ul class="space-y-1 text-sm flex-grow">
                `;
                team.squad.forEach(p => {
                    html += `
                        <li class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full ${p.slab === 'gold' ? 'bg-yellow-500' : p.slab === 'silver' ? 'bg-gray-500' : 'bg-yellow-700'} flex-shrink-0"></span>
                            <span>${p.name}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                // Only add analysis button for the main game over screen
                if (containerId === 'finalSquads') {
                    html += `
                        <button class="ai-analysis-btn w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-md transition duration-300" data-team-index="${index}">✨ Get AI Squad Analysis</button>
                        <div class="analysis-result mt-3 text-xs text-left text-gray-300 bg-gray-900/50 p-3 rounded-md hidden whitespace-pre-wrap" id="analysis-result-${index}"></div>
                    `;
                }
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;

            if (containerId === 'finalSquads') {
                setupAnalysisButtonListeners();
            }
        }

        function updatePurseDisplay(teamId) {
            // ... (existing updatePurseDisplay code, unchanged) ...
            if (teamId === 0) {
                $('#userPurse').textContent = `Purse: $${teams[0].purse.toFixed(1)}M`;
            }
        }
        
        function updateNumberRange() {
            // ... (existing updateNumberRange code, unchanged) ...
            const slab = $('#slabSelect').value;
            const max = PLAYER_DATA[slab].length;
            $('#numberRange').textContent = `1 - ${max}`;
            $('#numberInput').max = max;
        }

        function logMessage(message, color = 'gray') {
            const colors = {
                gray: 'text-gray-400',
                gold: 'text-yellow-400',
                green: 'text-green-400',
                red: 'text-red-400'
            };
            const logEntry = document.createElement('p');
            logEntry.className = ` ${colors[color] || colors['gray']} anote`;
            logEntry.textContent = message;

            const logContainer = $('#gameLog');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            gameState.gameLog.push(message);
        }
        
        function startTimer(barElement, seconds, onEnd) {
            // ... (existing startTimer code, unchanged) ...
            clearInterval(timerInterval);
            let width = 100;
            const decrement = 100 / (seconds * 10);
            timerInterval = setInterval(() => {
                width -= decrement;
                barElement.style.width = `${width}%`;
                if (width <= 0) {
                    clearInterval(timerInterval);
                    onEnd();
                }
            }, 100);
        }

        function showModalPrompt(text, options, showBidInput = false) {
            // ... (existing showModalPrompt code, slightly modified for new structure) ...
            return new Promise(resolve => {
                const modalContent = `
                    <h3 id="modalTitle" class="text-2xl font-bold mb-4">${teams[0].name}</h3>
                    <p id="modalText" class="text-gray-300 mb-6">${text}</p>
                    <div id="modalTimer" class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
                        <div id="modalTimerBar" class="bg-blue-500 h-2.5 rounded-full timer-bar" style="width: 100%"></div>
                    </div>
                    <div id="modalButtons" class="flex justify-end gap-4"></div>
                    <div id="modalBidInputContainer" class="${showBidInput ? '' : 'hidden'} mt-4">
                        <label for="bidAmount" class="block text-sm font-medium text-gray-300 mb-2">Enter Bid Amount (in Millions)</label>
                        <input type="number" id="bidAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="e.g., 5.5">
                    </div>
                `;
                $('#modal-content-container').innerHTML = modalContent;
                $('#modal').classList.remove('hidden');
                $('#modal').classList.add('flex');

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'px-6 py-2 rounded-md font-semibold transition';
                    button.className += (option.toLowerCase().includes('reject') || option.toLowerCase().includes('pass')) 
                        ? ' bg-red-600 hover:bg-red-700' 
                        : ' bg-green-600 hover:bg-green-700';
                    button.onclick = () => {
                        hideModal();
                        resolve(!option.toLowerCase().includes('reject') && !option.toLowerCase().includes('pass'));
                    };
                    $('#modalButtons').appendChild(button);
                });
                
                startTimer($('#modalTimerBar'), CONFIG.DECISION_TIMER_SECONDS, () => {
                    hideModal();
                    resolve(false); 
                });
            });
        }
        
        // --- TUTORIAL LOGIC (unchanged) ---
        function startTutorial() {
            // This function is not fully implemented in the provided code.
            // A placeholder to prevent errors if called.
            console.log("Tutorial started");
            showInfoModal("Tutorial", "The tutorial feature is not yet fully implemented.");
        }

        function runTutorialStep() {
            // Placeholder
        }
        
        // --- GEMINI API INTEGRATION ---

        /**
         * Calls the Gemini API with a given prompt.
         * @param {string} prompt - The prompt to send to the API.
         * @param {boolean} expectJson - Whether to expect a JSON response.
         * @returns {Promise<string|null>} The text response from the API or null on error.
         */
        async function callGeminiApi(prompt, expectJson = false) {
            const apiKey = ""; // API key is handled by the execution environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (expectJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error("API Error Response:", await response.text());
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                const responseText = candidate?.content?.parts?.[0]?.text;

                if (responseText) {
                    return responseText;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return null;
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showInfoModal("API Error", "Could not connect to the AI service. Please try again later.");
                return null;
            }
        }

        function showLoadingModal(text) {
            const modalContent = `
                <div class="flex flex-col items-center justify-center">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-300 text-lg">${text}</p>
                </div>
            `;
            $('#modal-content-container').innerHTML = modalContent;
            $('#modal').classList.remove('hidden');
            $('#modal').classList.add('flex');
        }

        function showInfoModal(title, text) {
             const modalContent = `
                <h3 class="text-2xl font-bold mb-4">${title}</h3>
                <p class="text-gray-300 mb-6">${text}</p>
                <div class="flex justify-end">
                    <button id="modal-ok-btn" class="px-6 py-2 rounded-md font-semibold transition bg-blue-600 hover:bg-blue-700">OK</button>
                </div>
            `;
            $('#modal-content-container').innerHTML = modalContent;
            $('#modal').classList.remove('hidden');
            $('#modal').classList.add('flex');
            $('#modal-ok-btn').onclick = hideModal;
        }

        function showNameSuggestionModal(names) {
            let buttonsHtml = names.map(name => 
                `<button class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md transition name-suggestion">${name}</button>`
            ).join('');

            const modalContent = `
                <h3 class="text-2xl font-bold mb-4">✨ AI Team Name Suggestions</h3>
                <div class="space-y-2">${buttonsHtml}</div>
                <div class="flex justify-end mt-6">
                     <button id="modal-close-btn" class="px-6 py-2 rounded-md font-semibold transition bg-gray-500 hover:bg-gray-600">Close</button>
                </div>
            `;
             $('#modal-content-container').innerHTML = modalContent;
            $('#modal').classList.remove('hidden');
            $('#modal').classList.add('flex');

            $$('.name-suggestion').forEach(button => {
                button.onclick = () => {
                    $('#teamNameInput').value = button.textContent;
                    hideModal();
                };
            });
            $('#modal-close-btn').onclick = hideModal;
        }

        function hideModal() {
            clearInterval(timerInterval);
            $('#modal').classList.add('hidden');
        }

        function setupAnalysisButtonListeners() {
            $$('.ai-analysis-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const btn = e.target;
                    const teamIndex = btn.dataset.teamIndex;
                    const resultDiv = $(`#analysis-result-${teamIndex}`);
                    
                    const finalTeamsData = JSON.parse(localStorage.getItem('lastCricketGame') || '[]');
                    const team = finalTeamsData[teamIndex];
                    if (!team) return;
                    
                    btn.disabled = true;
                    resultDiv.classList.remove('hidden');
                    resultDiv.innerHTML = `<div class="flex items-center justify-center p-4"><div class="loader"></div></div>`;

                    const squadDetails = team.squad.map(p => `${p.name} (Slab: ${p.slab}, Perk: ${p.perk})`).join(', ');
                    const prompt = `You are a world-class cricket analyst. Analyze the following fantasy cricket squad and provide a concise summary (around 100-120 words) covering its primary strengths, potential weaknesses, and a suggested strategic approach. Format your response with "Strengths:", "Weaknesses:", and "Strategy:" as bolded headings. Squad: ${squadDetails}`;

                    const analysis = await callGeminiApi(prompt);
                    
                    if (analysis) {
                        resultDiv.innerHTML = analysis.replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-300">$1</strong>');
                    } else {
                        resultDiv.innerHTML = `<p class="text-red-400">Analysis failed. Please try again.</p>`;
                    }
                    btn.disabled = false;
                });
            });
        }

        // --- EVENT LISTENERS ---
        $('#startGameBtn').addEventListener('click', () => {
             if (!$('#teamNameInput').value) {
                showInfoModal("Team Name Required", "Please enter a team name to start the game.");
                return;
            }
            gameState.tutorialActive = false;
            initGame();
        });
        
        $('#playAgainBtn').addEventListener('click', () => {
            $('#gameOverScreen').classList.add('hidden');
            $('#homeScreen').classList.remove('hidden');
        });

        $('#viewLastGameBtn').addEventListener('click', () => {
             $('#homeScreen').classList.add('hidden');
             $('#lastGameScreen').classList.remove('hidden');
             renderFinalSquads('lastGameSquads');
        });

        $('#backToHomeBtn').addEventListener('click', () => {
            $('#lastGameScreen').classList.add('hidden');
            $('#homeScreen').classList.remove('hidden');
        });
        
        $('#tutorialBtn').addEventListener('click', () => {
            if (!$('#teamNameInput').value) {
                showInfoModal("Team Name Required", "Please enter a team name before starting the tutorial.");
                return;
            }
            startTutorial();
        });

        $('#suggestNameBtn').addEventListener('click', async () => {
            showLoadingModal("✨ Generating creative team names...");
            const prompt = `Generate exactly 5 cool, creative, and epic team names for a fantasy cricket team. The names should be unique and powerful. Return them as a single JSON array of strings. Example: ["Cosmic Comets", "Velocity Vipers"]`;
            const responseText = await callGeminiApi(prompt, true);
            
            if (responseText) {
                try {
                    const names = JSON.parse(responseText);
                    showNameSuggestionModal(names);
                } catch (e) {
                    console.error("Failed to parse team names JSON", e);
                    showInfoModal("Error", "Sorry, there was an issue getting suggestions.");
                }
            }
            // Error is handled inside callGeminiApi by showing a modal
        });


        // --- INITIALIZATION ---
        generatePlayers();
    </script>
</body>
</html>


